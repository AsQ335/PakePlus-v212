# 代理模式配置指南

## 问题分析

### 为什么系统代理模式失败？

**系统代理模式的问题：**

```
Tauri WebView
    ↓
直接发起 TLS 握手（暴露 WebView 特征）
    ↓
HTTP CONNECT 隧道
    ↓
Clash 代理（只是转发，不处理 TLS）
    ↓
Cloudflare ❌ 检测到 WebView 的 TLS 指纹
```

**TUN 模式的优势：**

```
Tauri WebView
    ↓
发送原始 IP 包
    ↓
TUN 虚拟网卡
    ↓
Clash 完全接管（重新建立 TLS 连接）
    ↓
Cloudflare ✅ 看到的是 Clash 的 TLS 指纹（正常）
```

## 解决方案

### 方案 1：使用 TUN 模式 + fake-ip（推荐）

#### 步骤 1：修改 Clash 配置

在你的 Clash 配置文件中，确保：

```yaml
dns:
  enable: true
  enhanced-mode: fake-ip  # 关键！
  fake-ip-range: 198.18.0.1/16
  nameserver:
    - 'https://223.5.5.5/dns-query'
    - 'https://doh.pub/dns-query'
  fallback:
    - 'tls://1.0.0.1:853'
    - 'tls://8.8.4.4:853'
```

#### 步骤 2：启用 TUN 模式

在 Clash Verge 中：
1. 设置 → TUN 模式 → **开启**
2. 设置 → 系统代理 → **关闭**

#### 为什么这样有效？

**fake-ip 模式：**
- DNS 查询被 Clash 拦截
- 返回假的 IP 地址（198.18.x.x）
- 所有流量都经过 Clash 的 TUN 设备
- Clash 重新建立 TLS 连接
- Cloudflare 看到的是 Clash 的正常流量

### 方案 2：使用 SOCKS5 代理（备选）

如果不能使用 TUN 模式，可以强制使用 SOCKS5。

#### 修改 Tauri 启动参数

在 `src-tauri/src/main.rs` 或启动脚本中：

**Windows:**
```cmd
set ALL_PROXY=socks5://127.0.0.1:7891
PakePlus.exe
```

**macOS/Linux:**
```bash
export ALL_PROXY=socks5://127.0.0.1:7891
./PakePlus
```

#### 为什么 SOCKS5 更好？

```
Tauri WebView
    ↓
SOCKS5 协议（传递域名，不是 IP）
    ↓
Clash 接收域名
    ↓
Clash 解析 DNS 并建立 TLS 连接
    ↓
Cloudflare ✅ 看到的是 Clash 的流量
```

### 方案 3：在应用中提示用户

在应用启动时检测代理模式，提示用户：

```javascript
// 在 custom.js 中添加
(function() {
  // 检测是否使用系统代理
  const isSystemProxy = !!window.navigator.onLine && 
                        (!!process.env.HTTP_PROXY || !!process.env.HTTPS_PROXY);
  
  if (isSystemProxy) {
    console.warn('[代理检测] 检测到系统代理模式');
    console.warn('[代理检测] 建议使用 TUN 模式以获得更好的兼容性');
    
    // 可以显示一个提示框
    setTimeout(() => {
      if (confirm('检测到系统代理模式，建议切换到 TUN 模式以获得更好的兼容性。\n\n是否查看配置指南？')) {
        // 打开配置指南
      }
    }, 2000);
  }
})();
```

## 技术细节

### 系统代理模式的 TLS 指纹问题

**WebView2 (Windows) 的 TLS 指纹：**
```
TLS Version: 1.3
Cipher Suites: 特定的组合（与 Chrome 不同）
Extensions: 特定的扩展顺序
ALPN: h2, http/1.1
```

**Cloudflare 的检测：**
```javascript
// Cloudflare 可能的检测逻辑
if (tls_fingerprint === WEBVIEW2_SIGNATURE) {
  return 'Automated browser detected';
}
```

### TUN 模式如何解决

**Clash 的 TLS 指纹：**
```
TLS Version: 1.3
Cipher Suites: 模拟真实浏览器
Extensions: 正常顺序
ALPN: h2, http/1.1
```

**关键：** Clash 使用 Go 的 TLS 库，可以配置为模拟真实浏览器的 TLS 指纹。

## 配置示例

### 完整的 Clash 配置（推荐）

```yaml
port: 7890
socks-port: 7891
redir-port: 7892
tproxy-port: 7893
mixed-port: 7890

allow-lan: true
mode: rule
log-level: info

external-controller: '0.0.0.0:9090'

# 关键配置
dns:
  enable: true
  ipv6: false
  listen: '0.0.0.0:53'
  enhanced-mode: fake-ip  # 必须是 fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter:
    - '*.lan'
    - 'localhost.ptlogin2.qq.com'
  nameserver:
    - 'https://223.5.5.5/dns-query'
    - 'https://doh.pub/dns-query'
  fallback:
    - 'tls://1.0.0.1:853'
    - 'tls://8.8.4.4:853'
  fallback-filter:
    geoip: true
    ipcidr:
      - 240.0.0.0/4

# TUN 配置（如果支持）
tun:
  enable: true
  stack: system
  dns-hijack:
    - any:53
  auto-route: true
  auto-detect-interface: true

# 你的代理节点配置
proxies:
  # ... 你的节点 ...

proxy-groups:
  - name: '节点列表'
    type: select
    proxies:
      # ... 你的节点 ...

rules:
  # ... 你的规则 ...
```

### Clash Verge 设置

1. **TUN 模式：** 开启
2. **系统代理：** 关闭
3. **DNS 模式：** fake-ip
4. **自动路由：** 开启

## 测试验证

### 1. 检查 DNS 模式

```bash
# Windows
nslookup lmarena.ai

# 应该返回 198.18.x.x 的地址（fake-ip）
```

### 2. 检查 TUN 设备

```bash
# Windows
ipconfig

# 应该看到一个 Clash 的虚拟网卡
```

### 3. 访问测试

在 PakePlus 中访问 `https://lmarena.ai`，应该能通过验证。

## 常见问题

### Q1: 为什么之前 TUN 模式可以，现在不行了？

**可能原因：**
1. Cloudflare 更新了检测规则
2. Clash 配置改变了（比如 DNS 模式从 fake-ip 改成了 redir-host）
3. lmarena.ai 加强了验证

**解决：**
确保使用 fake-ip 模式。

### Q2: 不能使用 TUN 模式怎么办？

**原因：**
- 需要管理员权限
- 系统不支持
- 与其他 VPN 冲突

**解决：**
使用方案 2（SOCKS5 代理）。

### Q3: fake-ip 会影响其他应用吗？

**不会。** fake-ip 只在 Clash 内部使用，其他应用看到的仍然是真实 IP。

### Q4: 如何确认使用的是 fake-ip？

在浏览器或应用中访问任何网站，然后在 Clash 日志中查看：

```
[DNS] lmarena.ai --> 198.18.0.1 (fake-ip)
```

## 总结

**推荐配置：**
- ✅ TUN 模式
- ✅ fake-ip DNS
- ✅ 自动路由

**不推荐：**
- ❌ 系统代理模式（TLS 指纹暴露）
- ❌ redir-host DNS 模式（可能泄露）

**原理：**
TUN 模式让 Clash 完全接管网络栈，重新建立 TLS 连接，隐藏了 WebView 的特征。

---

**版本：** 1.0.0  
**日期：** 2025-11-17
