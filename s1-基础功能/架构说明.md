# 架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      PakePlus 应用                           │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   Tauri 框架                          │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │              WebView 窗口                       │  │  │
│  │  │  ┌───────────────────────────────────────────┐  │  │  │
│  │  │  │         目标网页内容                      │  │  │  │
│  │  │  │  ┌─────────────────────────────────────┐  │  │  │  │
│  │  │  │  │    onechat-custom.js 注入脚本       │  │  │  │  │
│  │  │  │  │  ┌───────────────────────────────┐  │  │  │  │  │
│  │  │  │  │  │  PakePlus 原有功能           │  │  │  │  │  │
│  │  │  │  │  │  - hookClick                 │  │  │  │  │  │
│  │  │  │  │  │  - window.open 重写          │  │  │  │  │  │
│  │  │  │  │  └───────────────────────────────┘  │  │  │  │  │
│  │  │  │  │  ┌───────────────────────────────┐  │  │  │  │  │
│  │  │  │  │  │  OneChat 功能模块            │  │  │  │  │  │
│  │  │  │  │  │  - AntiFlashModule           │  │  │  │  │  │
│  │  │  │  │  │  - DomainReplacementModule   │  │  │  │  │  │
│  │  │  │  │  │  - BrandStylesModule         │  │  │  │  │  │
│  │  │  │  │  │  - PageModificationsModule   │  │  │  │  │  │
│  │  │  │  │  │  - ExecutionManager          │  │  │  │  │  │
│  │  │  │  │  └───────────────────────────────┘  │  │  │  │  │
│  │  │  │  └─────────────────────────────────────┘  │  │  │  │
│  │  │  └───────────────────────────────────────────┘  │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 脚本注入流程

```
应用启动
    ↓
Tauri 初始化
    ↓
创建 WebView 窗口
    ↓
.initialization_script(include_str!("../../data/custom.js"))
    ↓
脚本在页面加载前注入
    ↓
┌─────────────────────────────────────┐
│  1. PakePlus 功能立即执行           │
│     - 注册 click 事件监听器         │
│     - 重写 window.open              │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│  2. OneChat 功能立即执行            │
│     - 隐藏页面（防闪现）            │
│     - 初始化各模块                  │
│     - 执行域名替换                  │
│     - 执行页面修改                  │
│     - 设置监听器                    │
└─────────────────────────────────────┘
    ↓
页面开始加载
    ↓
DOM 构建
    ↓
持续监听和处理
    ↓
延迟后显示页面
```

## 模块架构

### 1. PakePlus 原有模块

```
PakePlus 功能
├── hookClick
│   ├── 监听所有点击事件
│   ├── 检测 <a> 标签
│   ├── 检测 target="_blank"
│   └── 阻止新窗口，转为当前窗口跳转
│
└── window.open 重写
    ├── 拦截 window.open 调用
    └── 转为 location.href 跳转
```

### 2. OneChat 模块架构

```
OneChat 功能
│
├── AntiFlashModule（防闪现模块）
│   ├── hide()          # 隐藏页面
│   └── show()          # 显示页面
│
├── DomainReplacementModule（域名替换模块）
│   ├── domainMapping   # 域名映射表
│   ├── patterns        # 编译的正则表达式
│   ├── processedNodes  # 已处理节点集合
│   ├── init()          # 初始化
│   ├── replaceTextContent()      # 替换单个文本节点
│   ├── replaceAllText()          # 替换所有文本节点
│   └── processNewNodes()         # 处理新节点
│
├── BrandStylesModule（品牌样式模块）
│   ├── oneChatLogoLarge   # 大尺寸 Logo
│   ├── oneChatLogoMedium  # 中等尺寸 Logo
│   ├── oneChatLogoSmall   # 小尺寸 Logo
│   └── colors             # 品牌颜色
│
├── PageModificationsModule（页面修改模块）
│   ├── init()             # 初始化
│   ├── hideBanner()       # 隐藏横幅
│   ├── replaceMainTitle() # 替换主标题
│   ├── removeSubtitle()   # 删除副标题
│   ├── removeLoveButton() # 删除爱心按钮
│   ├── applyAll()         # 应用所有修改
│   └── needsReapply()     # 检查是否需要重新应用
│
└── ExecutionManager（执行管理模块）
    ├── applyAllModifications()   # 执行所有修改
    ├── setupMutationObserver()   # 设置 DOM 监听
    ├── setupPeriodicCheck()      # 设置定期检查
    ├── setupEventListeners()     # 设置事件监听
    └── init()                    # 初始化所有模块
```

## 数据流图

### 域名替换流程

```
页面内容
    ↓
┌─────────────────────────────────┐
│  TreeWalker 遍历文本节点        │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  过滤器：跳过 script/style      │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  检查是否包含目标域名           │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  正则表达式替换                 │
│  lmarena.ai → onechat.ai        │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  更新节点内容                   │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  标记为已处理（WeakSet）        │
└─────────────────────────────────┘
```

### 页面修改流程

```
页面加载
    ↓
┌─────────────────────────────────┐
│  查找目标元素                   │
│  - querySelector                │
│  - querySelectorAll             │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  验证元素                       │
│  - 检查文本内容                 │
│  - 检查属性                     │
│  - 检查位置                     │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  应用修改                       │
│  - 修改样式（display: none）    │
│  - 修改内容（innerHTML）        │
│  - 删除元素（remove()）         │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  返回结果                       │
│  - true: 成功                   │
│  - false: 未找到元素            │
└─────────────────────────────────┘
```

### 监听机制

```
┌─────────────────────────────────────────────────────────┐
│                    监听机制                              │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │  MutationObserver（DOM 变化监听）              │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │  监听类型：                              │  │    │
│  │  │  - childList: true                       │  │    │
│  │  │  - subtree: true                         │  │    │
│  │  │  - characterData: true                   │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │  触发条件：                              │  │    │
│  │  │  - 新节点添加                            │  │    │
│  │  │  - 文本内容变化                          │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │  处理动作：                              │  │    │
│  │  │  - 立即替换新节点中的域名                │  │    │
│  │  │  - 检查是否需要重新应用页面修改          │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │  setInterval（定期检查）                       │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │  检查频率：100ms                         │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │  检查内容：                              │  │    │
│  │  │  - 扫描所有文本节点                      │  │    │
│  │  │  - 检查页面修改是否需要重新应用          │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │  事件监听                                      │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │  - DOMContentLoaded                      │  │    │
│  │  │  - load                                  │  │    │
│  │  │  - popstate                              │  │    │
│  │  │  - visibilitychange                      │  │    │
│  │  │  - beforeunload                          │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │  History API 拦截                              │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │  - history.pushState                     │  │    │
│  │  │  - history.replaceState                  │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────┘    │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

## 时序图

### 完整执行时序

```
时间轴 →

T0: 应用启动
    |
    ├─ Tauri 初始化
    |
T1: 创建 WebView
    |
    ├─ 注入 custom.js
    |
T2: 脚本开始执行
    |
    ├─ PakePlus 功能注册
    |  ├─ hookClick 监听器
    |  └─ window.open 重写
    |
    ├─ OneChat 初始化
    |  ├─ 隐藏页面（opacity: 0）
    |  ├─ 初始化模块
    |  └─ 立即执行一次替换
    |
T3: 页面开始加载
    |
    ├─ HTML 解析
    |  └─ 域名替换（实时）
    |
    ├─ DOM 构建
    |  └─ 页面修改（实时）
    |
T4: DOMContentLoaded
    |
    ├─ 执行所有修改
    |  ├─ 域名替换
    |  └─ 页面修改
    |
T5: 延迟 200ms
    |
    ├─ 显示页面（opacity: 1）
    |
T6: 页面完全加载
    |
    ├─ 再次执行所有修改
    |
T7: 持续运行
    |
    ├─ MutationObserver 监听
    |  └─ 处理新内容（实时）
    |
    ├─ 定期检查（每 100ms）
    |  └─ 扫描和修复
    |
    └─ 事件响应
       └─ 页面导航、可见性变化等
```

## 配置层次

```
┌─────────────────────────────────────────────────────────┐
│                   GLOBAL_CONFIG                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │  基础配置                                         │  │
│  │  - verbose: 日志开关                             │  │
│  │  - enableDomainReplacement: 域名替换开关         │  │
│  │  - enablePageModifications: 页面修改开关         │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  防闪现配置                                       │  │
│  │  - enableAntiFlash: 防闪现开关                   │  │
│  │  - antiFlashDelay: 延迟时间                      │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  监听配置                                         │  │
│  │  - enableMutationObserver: DOM 监听开关          │  │
│  │  - enablePeriodicCheck: 定期检查开关             │  │
│  │  - periodicCheckInterval: 检查间隔               │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
         ↓                    ↓                    ↓
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ 域名映射配置    │  │ 品牌样式配置    │  │ 页面修改配置    │
│ domainMapping   │  │ BrandStyles     │  │ PageMods        │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

## 性能优化策略

```
┌─────────────────────────────────────────────────────────┐
│                    性能优化                              │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  1. 节点处理优化                                         │
│     ├─ WeakSet 防止重复处理                             │
│     ├─ TreeWalker 高效遍历                              │
│     └─ 智能过滤（跳过 script/style）                    │
│                                                          │
│  2. 监听优化                                             │
│     ├─ 条件性启用监听器                                 │
│     ├─ 可配置的检查频率                                 │
│     └─ 智能判断是否需要重新应用                         │
│                                                          │
│  3. 执行优化                                             │
│     ├─ 立即执行（不等待 DOM）                           │
│     ├─ 批量处理节点                                     │
│     └─ 异步非阻塞                                       │
│                                                          │
│  4. 内存优化                                             │
│     ├─ WeakSet 自动垃圾回收                             │
│     ├─ 避免内存泄漏                                     │
│     └─ 及时清理引用                                     │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

## 错误处理机制

```
┌─────────────────────────────────────────────────────────┐
│                  错误处理                                │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  safeExecute() 包装器                                    │
│     ↓                                                    │
│  try {                                                   │
│     执行功能函数                                         │
│     ├─ 成功 → 返回 true，记录成功日志                   │
│     └─ 未找到元素 → 返回 false，记录警告                │
│  }                                                       │
│  catch (error) {                                         │
│     捕获异常 → 返回 false，记录错误日志                 │
│  }                                                       │
│     ↓                                                    │
│  不影响其他功能继续执行                                  │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

## 调试接口

```
window.OneChat
├── config                    # 配置对象
│   ├── verbose
│   ├── enableDomainReplacement
│   ├── enablePageModifications
│   └── ...
│
├── antiFlash                 # 防闪现模块
│   ├── hide()
│   └── show()
│
├── domainReplace             # 域名替换模块
│   ├── domainMapping
│   ├── replaceAllText()
│   └── ...
│
├── brandStyles               # 品牌样式模块
│   ├── oneChatLogoLarge
│   └── colors
│
├── pageMod                   # 页面修改模块
│   ├── applyAll()
│   ├── needsReapply()
│   └── ...
│
├── manager                   # 执行管理模块
│   └── applyAllModifications()
│
└── 快捷方法
    ├── applyAll()            # 应用所有修改
    ├── showPage()            # 显示页面
    └── hidePage()            # 隐藏页面
```

## 部署架构

```
开发环境
    ↓
┌─────────────────────────────────┐
│  修改 custom.js                 │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  pnpm run tauri:dev             │
│  - 实时预览                     │
│  - 开发者工具调试               │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  测试验证                       │
│  - 功能测试                     │
│  - 性能测试                     │
│  - 兼容性测试                   │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  pnpm run tauri:build           │
│  - 编译 Rust 代码               │
│  - 打包资源文件                 │
│  - 生成可执行文件               │
└─────────────────────────────────┘
    ↓
生产环境
    ↓
┌─────────────────────────────────┐
│  分发应用                       │
│  - Windows: .exe                │
│  - macOS: .app / .dmg           │
│  - Linux: .deb / .rpm           │
└─────────────────────────────────┘
```

## 总结

本架构采用模块化设计，各模块职责清晰，易于维护和扩展。通过多层次的监听机制确保功能的完整性和实时性，同时通过各种优化策略保证良好的性能表现。
